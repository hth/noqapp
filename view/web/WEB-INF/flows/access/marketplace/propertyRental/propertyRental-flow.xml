<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
      http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <secured attributes="ROLE_CLIENT" match="any"/>

    <on-start>
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'postId')" result="conversationScope.postId" />
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'businessTypeAsString')" result="conversationScope.businessTypeAsString" />
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'postingAllowed')" result="conversationScope.postingAllowed" />
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'editMode')" result="conversationScope.editMode" />
        <evaluate expression="propertyRentalMarketplaceFlowActions.startOfNewPost(postId, businessTypeAsString, postingAllowed, externalContext)"
                  result="flowScope.marketplaceForm"/>
    </on-start>

    <view-state id="typeOfPost" model="marketplaceForm">
        <transition on="submit" to="validateStartOfMarketplacePost"/>
    </view-state>

    <action-state id="validateStartOfMarketplacePost">
        <evaluate expression="propertyRentalMarketplaceValidator.validateStartOfMarketplace(marketplaceForm, messageContext)"/>
        <transition on="success" to="titleDescriptionOfPost"/>
        <transition on="failure" to="typeOfPost"/>
    </action-state>

    <view-state id="titleDescriptionOfPost" model="marketplaceForm">
        <on-entry>
            <evaluate expression="propertyRentalMarketplaceFlowActions.afterPostTypeHasBeenSelected(marketplaceForm)" />
        </on-entry>
        <transition on="submit" to="validateTitleDescription"/>
        <transition on="cancel" to="home"/>
    </view-state>

    <action-state id="validateTitleDescription">
        <evaluate expression="propertyRentalMarketplaceValidator.validateTitleDescription(marketplaceForm, messageContext)"/>
        <transition on="success" to="thePostDetail"/>
        <transition on="failure" to="titleDescriptionOfPost"/>
    </action-state>

    <view-state id="thePostDetail" model="marketplaceForm">
        <transition on="submit" to="readyToPost"/>
        <transition on="cancel" to="home"/>
    </view-state>

    <action-state id="readyToPost">
        <evaluate expression="propertyRentalMarketplaceValidator.validateReadyToPostMarketplace(marketplaceForm, messageContext)"/>
        <transition on="success" to="reviewBeforePost"/>
        <transition on="failure" to="thePostDetail"/>
    </action-state>

    <view-state id="reviewBeforePost" model="marketplaceForm">
        <transition on="submit" to="completeNewPost" history="invalidate"/>
        <transition on="cancel" to="home"/>
    </view-state>

    <action-state id="completeNewPost">
        <!-- Need the result to show correct message on JSP -->
        <evaluate expression="propertyRentalMarketplaceFlowActions.completeNewPost(marketplaceForm)"/>
        <transition on="success" to="home"/>
        <transition on="failure" to="reviewBeforePost"/>
    </action-state>

    <view-state id="registrationComplete" view="externalRedirect:contextRelative:/access/landing"/>
    <end-state id="home" view="externalRedirect:contextRelative:/access/landing"/>

    <global-transitions>
        <transition on="cancel" to="home"/>
    </global-transitions>
</flow>
