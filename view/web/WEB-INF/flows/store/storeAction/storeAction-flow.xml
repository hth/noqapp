<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
       http://www.springframework.org/schema/webflow/spring-webflow-2.4.xsd">

    <secured attributes="ROLE_M_ADMIN" match="any"/>

    <on-start>
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'bizStoreId')" result="conversationScope.bizStoreId" />
        <evaluate expression="storeFlowActions.populateStore(bizStoreId)"
                  result="flowScope.registerBusiness"/>
    </on-start>

    <view-state id="registrationStart" model="registerBusiness">
        <transition on="submit" to="validateStoreDetails"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateStoreDetails">
        <evaluate expression="businessFlowValidator.validateStoreDetails(registerBusiness, '', messageContext)"/>
        <transition on="success" to="queueSettings"/>
        <transition on="failure" to="registrationStart"/>
    </action-state>

    <view-state id="queueSettings" model="registerBusiness">
        <transition on="submit" to="validateQueueSettings"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateQueueSettings">
        <evaluate expression="businessFlowValidator.validateQueueSettings(registerBusiness, '', messageContext)"/>
        <transition on="success" to="businessHours" />
        <transition on="failure" to="queueSettings"/>
    </action-state>

    <view-state id="businessHours" model="registerBusiness">
        <transition on="submit" to="validateBusinessHours"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateBusinessHours">
        <evaluate expression="businessFlowValidator.validateBusinessHours(registerBusiness, '', messageContext)"/>
        <transition on="success" to="registrationReview">
            <evaluate expression="migrateToBusinessRegistrationFlowActions.fillWithBusinessHour(registerBusiness)"/>
        </transition>
        <transition on="failure" to="businessHours"/>
    </action-state>

    <view-state id="registrationReview">
        <!-- discard history to prevent back flow, invalidate to prevent back flow for all states -->
        <transition on="confirm" to="completeRegistrationInformation" history="invalidate"/>
        <transition on="revise" to="registrationStart"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="completeRegistrationInformation">
        <!-- Need the result to show correct message on JSP -->
        <evaluate result="registerBusiness"
                  expression="migrateToBusinessRegistrationFlowActions.completeRegistrationInformation(registerBusiness)"/>

        <transition on-exception="com.noqapp.view.flow.merchant.exception.MigrateToBusinessRegistrationException"
                    to="validateStoreDetails"/>

        <transition to="registrationComplete"/>
    </action-state>

    <view-state id="registrationComplete" view="externalRedirect:contextRelative:/business/landing.htm"/>
    <end-state id="logout" view="externalRedirect:contextRelative:/business/landing.htm"/>

    <global-transitions>
        <transition on="cancel" to="logout"/>
    </global-transitions>

</flow>