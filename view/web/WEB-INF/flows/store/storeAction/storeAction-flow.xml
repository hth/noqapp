<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns="http://www.springframework.org/schema/webflow"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
      http://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <secured attributes="ROLE_M_ADMIN, ROLE_TECHNICIAN, ROLE_SUPERVISOR" match="any"/>

    <on-start>
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'bizStoreId')"
                  result="conversationScope.bizStoreId"/>
        <evaluate expression="webFlowUtils.getFlashAttribute(externalContext, 'storeFranchise')"
                  result="conversationScope.storeFranchise"/>

        <evaluate expression="storeFlowActions.populateStore(bizStoreId, storeFranchise)"
                  result="flowScope.registerBusiness"/>
    </on-start>

    <view-state id="registrationStart" model="registerBusiness">
        <transition on="submit" to="validateStoreDetails"/>
        <transition on="delete" to="deleteStore"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="deleteStore">
        <evaluate expression="storeFlowActions.deleteStore(bizStoreId)"/>
        <transition on="success" to="logout"/>
        <transition on="failure" to="registrationStart"/>
    </action-state>

    <action-state id="validateStoreDetails">
        <evaluate expression="businessFlowValidator.validateStoreDetails(registerBusiness, '', messageContext)"/>
        <transition on="success" to="additionalAttributes"/>
        <transition on="failure" to="registrationStart"/>
    </action-state>

    <view-state id="additionalAttributes" model="registerBusiness">
        <on-entry>
            <evaluate expression="migrateToBusinessRegistrationFlowActions.additionalAttributes(registerBusiness, 'bizStore')"/>
        </on-entry>
        <transition on="continue" to="validateAmenitiesAndFacilitiesSettings"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateAmenitiesAndFacilitiesSettings">
        <evaluate expression="businessFlowValidator.validateAmenitiesAndFacilitiesSettings(registerBusiness, '', messageContext)"/>
        <transition on="success" to="queueSettings"/>
        <transition on="failure" to="additionalAttributes"/>
    </action-state>

    <view-state id="queueSettings" model="registerBusiness">
        <transition on="submit" to="validateQueueSettings"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateQueueSettings">
        <evaluate expression="businessFlowValidator.validateQueueSettings(registerBusiness, '', messageContext)"/>
        <transition on="success" to="businessHours"/>
        <transition on="failure" to="queueSettings"/>
    </action-state>

    <view-state id="businessHours" model="registerBusiness">
        <transition on="submit" to="validateBusinessHours"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateBusinessHours">
        <evaluate expression="businessFlowValidator.validateBusinessHours(registerBusiness, '', messageContext)"/>
        <!-- When its for queue -->
        <transition on="Qsuccess" to="appointmentSettings">
            <evaluate expression="migrateToBusinessRegistrationFlowActions.fillWithBusinessHour(registerBusiness)"/>
        </transition>

        <!-- When its for order -->
        <transition on="Osuccess" to="registrationReview">
            <evaluate expression="migrateToBusinessRegistrationFlowActions.fillWithBusinessHour(registerBusiness)"/>
        </transition>
        <transition on="failure" to="businessHours"/>
    </action-state>

    <view-state id="appointmentSettings" model="registerBusiness">
        <transition on="submit" to="decideIfAppointmentIsEnabled"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <decision-state id="decideIfAppointmentIsEnabled">
        <if test="registerBusiness.appointmentState ne registerBusiness.appointmentIsOff" then="validateAppointmentSettings" else="registrationReview"/>
    </decision-state>

    <action-state id="validateAppointmentSettings">
        <evaluate expression="businessFlowValidator.validateAppointmentSettings(registerBusiness, '', messageContext)"/>
        <transition on="success" to="appointmentHours"/>
        <transition on="failure" to="appointmentSettings"/>
    </action-state>

    <view-state id="appointmentHours" model="registerBusiness">
        <transition on="submit" to="validateAppointmentHours"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="validateAppointmentHours">
        <evaluate expression="businessFlowValidator.validateAppointmentHours(registerBusiness, '', messageContext)"/>
        <transition on="success" to="registrationReview"/>
        <transition on="failure" to="appointmentHours"/>
    </action-state>

    <view-state id="registrationReview">
        <!-- discard history to prevent back flow, invalidate to prevent back flow for all states -->
        <transition on="confirm" to="completeRegistrationInformation" history="invalidate"/>
        <transition on="revise" to="registrationStart"/>
        <transition on="cancel" to="logout"/>
    </view-state>

    <action-state id="completeRegistrationInformation">
        <!-- Need the result to show correct message on JSP -->
        <evaluate result="registerBusiness"
                  expression="migrateToBusinessRegistrationFlowActions.completeRegistrationInformation(registerBusiness)"/>

        <transition on-exception="com.noqapp.view.flow.merchant.exception.MigrateToBusinessRegistrationException"
                    to="validateStoreDetails"/>

        <transition to="decideOnRegistrationComplete"/>
    </action-state>

    <decision-state id="decideOnRegistrationComplete">
        <if test="registerBusiness.decidePathTraversalOnRegistrationComplete()" then="registrationComplete" else="registrationCompleteAsManager"/>
    </decision-state>

    <view-state id="registrationComplete" view="externalRedirect:contextRelative:/business/landing.htm"/>
    <view-state id="registrationCompleteAsManager" view="externalRedirect:contextRelative:/business/store/landing.htm"/>
    <end-state id="logout" view="externalRedirect:contextRelative:/business/landing.htm"/>

    <global-transitions>
        <transition on="cancel" to="logout"/>
    </global-transitions>

</flow>
